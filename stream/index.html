<style>

	/* BASIC RESET -- from another project */
	ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,body,html,p,blockquote,fieldset,input{margin:0; padding:0;}

	/* HTML ELEMENTS -- from another project */
	body { background-color:black; font: 20px "Lucida Grande","Lucida Sans Unicode",Helvetica,Arial,Verdana,sans-serif; }
	h1 { padding:60px 0 0 40px; }
	p,form { padding:10px 40px; }
	a { color:#999; text-decoration:none; }
	a:hover { text-decoration:underline; }


	#livestream-not-started {
		font-size: 24pt;
		color: white;
		margin-top: 10%;
		padding: 30px;
	}

	.counter-holder {
		color: white;
		float: right;
		position: relative;
		padding: 8px; /*to match the button padding*/
	}

	/* youtube mobile embed styles. Taken from some guy's site */
	.embed-container {
		position: relative;
		padding-bottom: 56.25%;
		height: 0;
		overflow: hidden;
		max-width: 100%; /*non-standard*/
	}
	.embed-container iframe, .embed-container object, .embed-container embed, .embed-container audio { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
	#demo-audio img {
		height: 80%; /* have to do this for this particular image's aspect ratio. Should throw this out later */
		display: block;
		  margin-left: auto;
		  margin-right: auto;	
	}
	#demo-buttons button.w3-black { color:gray!important }
	
	/*keep a little margin at bottom below popup*/
	#dhamma-of-the-day { height: 95% }
	#id02 { height: 95% }
	#id01 { height: 95% }
	
	/* make close button larger and gray */
	.close-button { font-size: 20pt; color: rgb(186, 181, 181); }
	
	/* scroll within the popup, max height at 100% so overflow will scroll. Padding for the X button */
	.main-content { overflow-y: scroll; padding-top: 40px; height: 100% } 
	
	
	/* don't let the images get wider than popup. Auto scale height accordingly */
	.chant-image { width: 100%; }
	
	/* a little too much space taken up by the dhamma of the day images. Chop off the page numbers too */
	#dhamma-image-2, #dhamma-image-1 { margin-top: -40px }
	
</style>


<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>

    <!-- Set the viewport to show the page at a scale of 1.0, and make it non-scalable -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>

    <!-- Make it fullscreen / hide the browser URL bar -->
    <meta name="apple-mobile-web-app-capable" content="yes" />


    <!--
        Give the status bar another colour
        Valid values for "content" are: "default" (white), "black" and "black-translucent"
        If set to "default" or "black", the content is displayed below the status bar. If set to
        "black-translucent", the content is displayed under the bar.
    -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    

    <!--
        Add a Home icon.
        By default, Mobile Safari searches for a file named "apple-touch-icon.png" in the root directory of your website.
        If it can't find any image there, you can specify it using the code below. Make sure the image has a dimension
        of 114x114 and is a PNG file. The glossy finish and resizing for the different devices will be done automatically.

        In case you don't want the gloss applied, use "apple-touch-icon-precomposed" instead of "apple-touch-icon".
    -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png" /> <!-- apple-touch-icon.png -->

    <!--
        Add a splash screen / startup image.
        Take note this file exactly needs to be 320x460 for iPhone or 1004x768 for iPad, and is a PNG file.
        Also, this only works if "apple-mobile-web-app-capable" is set to "yes".
    -->
    <link rel="apple-touch-startup-image" href="images/startup.png" />

    <!--
        Prevent the user from elastic scrolling / rubber banding. Sadly, doesn't always work properly.
        For a more solid solution, check out ScrollFix ( https://github.com/joelambert/ScrollFix )
    -->

	<script src="schedule.js"></script>
	<script src="pageDataBook1.js"></script>
	<script src="pageDataBook2.js"></script>
    <script>
    function BlockElasticScroll(event) {
        //event.preventDefault() ;
    }

    // In JavaScript, you can use "window.navigator.standalone" to detect wether
    // the page is being viewed on your website, or as a standalone application.

    // You can also the detect the device the user is using.
    // var isIPhone = navigator.userAgent.indexOf("iPhone") != -1 ;
    // var isIPod = navigator.userAgent.indexOf("iPod") != -1 ;
    // var isIPad = navigator.userAgent.indexOf("iPad") != -1 ;
    // var isIOs = isIPhone || isIPod || isIPad ;
    
    function loadVideo() {
    	const videoIframe = document.getElementById("real-video");
    	const secondsUntilStart = LIVESTREAM.secondsUntilStart()
    	if(secondsUntilStart > 0) {
    		//livestream hasn't started yet. Tell them to come back at the right time.
			const startDate = new Date((new Date()).setHours(0,0,LIVESTREAM.info.startTimeInSeconds));
			const description =
					"Stream will start at "
					+startDate.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }).substr(11, 10)
					+" PT";
			displayVideoInfoDivWithMessage(description);

			// refresh once it's time to start!
			setTimeout(function () {
				location.reload();
			}, (secondsUntilStart + 1)* 1000)
		} else {
    		// it's already started

			//set up the url, whether it's streaming or prerecorded
			videoIframe.src = LIVESTREAM.generateUrl();

			const videoInfo = LIVESTREAM.getTodaysVideoInfo();
			if(videoInfo) {
				//it's a prerecorded video

				//seconds until start will be negative, I hope.
				const timeUntilEnd = secondsUntilStart + videoInfo.durationInSeconds;
				if(timeUntilEnd > 0) {
					// if it's NOT over (ie, currently running)
					alert("Don't forget to unmute for sound!");
				}

				//when it ends we can show an end message. That includes if it's already over
				setTimeout(function () {
					displayVideoInfoDivWithMessage("Session complete. Come back tomorrow!");
				}, timeUntilEnd * 1000) //even if timeUntilEnd is negative, this is good!
			}

		}
	}

	function displayVideoInfoDivWithMessage(message) {
		const videoIframe = document.getElementById("real-video");
		videoIframe.style.display = "none";
		const infoDiv = document.getElementById("livestream-not-started");
		infoDiv.style.display = "block";
		infoDiv.innerText= message;
	}

    function loadDhamma() {
    	const startPage = 9;
    	const endPage = 111;
    	const totalPages = endPage - startPage + 1;

    	const selectedOddPagesFromStart = 2 * Math.ceil(Math.random()*totalPages / 2) - 1; //want odd start page

    	let pageNum = selectedOddPagesFromStart - 1 + startPage;

    	
    	
    	
    	const prefix = "dhamma/dpr2-";
    	const suffix = ".png";
    	document.getElementById('dhamma-image-1').src = prefix + (""+pageNum).padStart(3, "0") + suffix;
    	document.getElementById('dhamma-image-2').src = prefix + (""+(pageNum + 1)).padStart(3, "0") + suffix;
    }
    
    function loadImages() {
    	loadImageSet(1,155); //155 pages in book 1, 89  in book 2
    	loadImageSet(2,	89);
    }
    
    function loadImageSet(bookNum, maxPage) {
    	const holder = document.getElementById('book'+bookNum+'images')
    	for(let i=1; i<= maxPage; i++) {
    		let newImage = document.createElement("img");
    		//<img id="2-73" class="chant-image" src="chanting-book-2/73.png">
    		newImage.src = "chanting-book-"+bookNum+"/"+i+".png";
    		newImage.className = "chant-image"
    		newImage.id = bookNum+"-"+i;
    		holder.appendChild(newImage);
    	}
    }
    
    function loadTOCs() {
    	loadTOC(1, pageDataBook1);
    	loadTOC(2, pageDataBook2);	
    }
    
    function loadTOC(bookNum, data) {
    	const holder = document.getElementById('toc-'+bookNum)
    	data.forEach(function(obj) {
    		//<p><a href="#" onclick=showPages(1, [3,4,5...]); event>Morning chanting</a></p>
    		let newPara = document.createElement("p");	
    		let newLink = document.createElement("a");	
    		newLink.href = "#"+bookNum+"-"+obj.startPage; //jump to that start page when clicked (so as to scroll TOC out of view)
    		newLink.innerHTML = obj.name+" ("+ (obj.startPage- START_PAGE_OFFSET ) + ")";
    		newLink.addEventListener("click", function(event) {
    			event.preventDefault();  
    			showPages(bookNum, obj)
    		})
    		newPara.appendChild(newLink);
    		holder.appendChild(newPara);
    	})	
    	
    }
    
    function showPages(bookNum, chantInfo) {
    	const pages = chantInfo.pages;
    	const holder = document.getElementById('book'+bookNum+'images')
    	
    	//hideAll images for book
    	
    	for(const element of holder.childNodes) if(element.style) element.style.display = "none"
    	
    	
    	//show only relevant ones
    	pages.forEach(pageNum => document.getElementById(bookNum+"-"+pageNum).style.display = "block")
    	
    	//jump to that ID
    	document.getElementById(bookNum+"-"+pages[0]).scrollIntoView(true)

		startAutoScrolling(holder.parentElement.scrollTop, holder.parentElement, chantInfo.pageScrollData)
    }



    function startAutoScrolling(startHeight, holder, scrollData) {
    	/*const listeningFunc = function (e) {
			console.log("caught scrolling! ;)")
		}
    	holder.addEventListener("scroll", listeningFunc)
		*/
		console.log("startHeight", startHeight)
		const currentPageNumber = function (currentHeight) {
			return Math.floor((currentHeight - startHeight) / fullPageHeight);
		}

		const heightWithinCurrentPage = function (currentHeight) {
			return (currentHeight - startHeight) % fullPageHeight;
		}

		const maxHeightForPage = function (pageNumber) {
			return (scrollData[pageNumber].trueEndHeight || 1) * fullPageHeight;
		}

		const marginHeightTopConstant = 20;
		const marginHeightBottomConstant = 30;
		const fullPageHeight = 753; //not sure if this is right
		// this is where we assume the user's eye should be on the first page before we start scroll
		const autoScrollStartOffsetFactor = 0.5;
		// truehight is the assumption of where the user's eye will be at any given time
		let trueHeight = (startHeight || 0) + marginHeightTopConstant;

		let isCurrentlyInMargin = true; //starts inside margin
		const marginScrollMultiplier = 2; // scroll this many times faster in the margin

		//assume page 0 for start
		let currentScrollRateInPx = scrollData[0].scrollRate;
		let currentPageMaxHeight = maxHeightForPage(0);
		const scrollingIntervalInMilliseconds = 10;


		const intervalFunctionId = setInterval(function () {
			// scroll 2x speed if in margin
			trueHeight += currentScrollRateInPx * (isCurrentlyInMargin ? marginScrollMultiplier : 1);
			//console.log("trueHeight", trueHeight)

			//check if we have left the margin
			const heightInCurrentPage = heightWithinCurrentPage(trueHeight);
			isCurrentlyInMargin = heightInCurrentPage < marginHeightTopConstant
					|| heightInCurrentPage > (fullPageHeight - marginHeightBottomConstant);

			//we have passed the end of this page. Let's see what to do next
			if(heightInCurrentPage > currentPageMaxHeight) {
				//try to get next page.
				const nextPageNumber = currentPageNumber(trueHeight) + 1
				const nextPageInfo = scrollData[nextPageNumber];
				if(nextPageInfo) {
					//there's another page. Update scroll constants, etc
					currentScrollRateInPx = nextPageInfo.scrollRate;
					currentPageMaxHeight = maxHeightForPage(nextPageNumber);
				} else {
					//we've reached the end. Stop here!
					console.log("done scrolling due to trueEnd on last page")
					clearInterval(intervalFunctionId);
				}
			}

			//actually scroll
			const browserScrollHeight = trueHeight - autoScrollStartOffsetFactor * holder.clientHeight;
			//console.log("browserScrollHeight", browserScrollHeight)
			if(browserScrollHeight > startHeight) {
				holder.scrollTo(0, browserScrollHeight);
			}




			//stop scrolling if we're at the bottom
			if(browserScrollHeight > holder.scrollHeight - holder.clientHeight) {
				console.log("done scrolling due to absolute bottom of holder elemnt")
				clearInterval(intervalFunctionId);
			}
		}, scrollingIntervalInMilliseconds)
	}
    
    function showAllPagesForBook(bookNum) {
    	const holder = document.getElementById('book'+bookNum+'images')
    	
    	//hideAll images for book
    	for(const element of holder.childNodes) if(element.style) element.style.display = "block"
    }
    
    function hideDemoStuff() {
    	document.getElementById('real-video').style.display='none';	
    	document.getElementById('demo-buttons').style.display='none';
    }
    
    const START_PAGE_OFFSET = 9;
    
	//TODO: blah globals
	//sort, since data comes out of order...
	const startPageSort = function(a, b) {
		return a.startPage - b.startPage;
	}
	pageDataBook1.sort(startPageSort);
	pageDataBook2.sort(startPageSort);

    </script>

    <title>Stream</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

</head>
<!-- document.getElementById('dhamma-of-the-day').style.display='block'; loadDhamma; -->
<body id=body onload="loadImages(); loadTOCs(); loadVideo();">
	
	
	


	<div class='embed-container'>
		<div id="livestream-not-started" style="display: none"></div>
		<iframe id="demo-video" style="display: none;" src='https://www.youtube.com/embed/zwuKRGndLN0?playsinline=1' frameborder='0'></iframe>
		<iframe id="real-video" src='' frameborder='0' ></iframe>
		<div id="demo-audio"  style="display: none;">
			<img src="chant-demo.jpeg"><br>
			<audio controls src="5-18-2020-puja-small.mp3">
	            Your browser does not support the
	            <code>audio</code> element.
	    	</audio>
    	</div>
	</div>

	<div class="w3-container">

	  <button onclick="document.getElementById('id01').style.display='block'" class="w3-button w3-black">Chanting Book 1</button>
	  <button onclick="document.getElementById('id02').style.display='block'" class="w3-button w3-black">Chanting Book 2</button>
		<div class="counter-holder">	Sangha online: <script type="text/javascript" src="//livecounter.theyosh.nl/3666.js"></script></div>
	  <div id="demo-buttons" style="margin-top: 50px; display:none;">
	  	<button class="w3-button w3-black" onclick="document.getElementById('demo-video').style.display='block'; hideDemoStuff()">(video demo)</button><br>
	  	<button class="w3-button w3-black" onclick="document.getElementById('demo-audio').style.display='block'; hideDemoStuff()">(audio demo)</button>
	  </div>
	  
	  
	  <!-- dhamma of the day ---> 
	  <div id="dhamma-of-the-day" class="w3-modal" style="display: none;"> <!-- block display for now --> 
	    <div class="w3-modal-content">
	      <div class="w3-container">
	        <span class="close-button" onclick="document.getElementById('dhamma-of-the-day').style.display='none'" class="w3-button w3-display-topright">&times;</span>
	        <div class="main-content">
	        	<img id="dhamma-image-1" class="chant-image" src="" >
	        	<img id="dhamma-image-2" class="chant-image" src="" >
	       	</div>
	      </div>
	    </div>
	  </div>
	  
	  
	  <!-- CHANTING BOOK 2 ---> 
	  
	  <div id="id02" class="w3-modal">
	    <div class="w3-modal-content">
	      <div class="w3-container">
	        <span class="close-button" onclick="document.getElementById('toc-2').scrollIntoView(true); document.getElementById('id02').style.display='none'; showAllPagesForBook(2)" class="w3-button w3-display-topright">&times;</span>
	        <div class="main-content">	        
	        	<div id="toc-2" class="toc">
	        		<!-- filled in by loadTOC -->
			    </div><!-- end TOC -->
			    
			    <div id="book2images" class="image-holder">
			    	<!-- onload, insert images here -->
			    	<!-- <img id="2-1" class="chant-image" src="chanting-book-2/1.png"> -->
			    </div>
		    </div>	 
	        
	      </div>
	    </div>
	  </div>
	  
	  <!-- CHANTING BOOK 1 ---> 
	
	  <div id="id01" class="w3-modal">
	    <div class="w3-modal-content">
	      <div class="w3-container">
	        <span id="close-button" onclick="document.getElementById('toc-1').scrollIntoView(true); document.getElementById('id01').style.display='none'; showAllPagesForBook(1)" class="w3-button w3-display-topright">&times;</span>
	        <div class="main-content">
			    <div id="toc-1" class="toc">
					<!-- filled in by loadTOC -->
			    </div><!-- end TOC -->
			    
			    <div id="book1images" class="image-holder">
					<!--loaded by loadImages: <img id="1-1" class="chant-image" src="chanting-book-1/1.png">-->
				
			    </div><!-- end image holder -->
        	</div><!-- end main content -->
		   
		   
	      </div>
	    </div>
	  </div>
	</div>

	





	


</body>
</html>
